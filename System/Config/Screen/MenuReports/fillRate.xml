<?xml version="1.0"?>
<!--
   - Filename:     fillRate.xml
   - Description:
   -
   - (c) COPYRIGHT QC Software, LLC 2018 All Rights Reserved
   - No part of this copyrighted work may be reproduced, modified, or
   - distributed in any form or by any means without the prior written
   - permission of QC Software, LLC.
   -
   - $Id: fillRate.xml 10242 2018-06-06 19:46:47Z wlw $
   - Notes:
  -->
<FLEXSCREEN title = "Fill Rate" 
            height = "400" 
            width = "600" 
            frametype = "internal"
            report = "true"
            updateSecurity = "fillRate.edit" 
            insertSecurity = "fillRate.edit"
            deleteSecurity = "fillRate.edit" >

  <!-- a dbConnect here is a universal connect object  -->
  <DBCONNECT type = "predefined" 
             connectionId = "default" 
             setglobal = "true"/>

  <GLOBAL_DEFINITIONS>
    <VECTOR name = "operators1"> 
       <ITEM value = " =" />
       <ITEM value = "like" />
    </VECTOR>

    <VECTOR name = "operators2"> 
       <ITEM value = " =" />
       <ITEM value = "&lt;" />
       <ITEM value = "&lt;=" />
       <ITEM value = "&lt;&gt;" />
       <ITEM value = "&gt;" />
       <ITEM value = "&gt;=" />
    </VECTOR>
    
    <VECTOR name = "operatorIn"> 
       <ITEM value = "in" />
       <ITEM value = "out" />
    </VECTOR>
  </GLOBAL_DEFINITIONS>

  <REPORTS preview = "true" records = "1000">
    <DBCONNECT type = "global" />
 
  </REPORTS>

  <SPLITPANE  divider = "200" orientation = "vertical">
    <FLEXTABLECOMPONENT name = "fillRate" 
                        init = "init" 
                        records = "1000"
                        refresh = "true" 
                        greenbar = "true"
                        ignoreEventConcatenation = "true">

      <DBCONNECT type = "global" />

      <TABLE key = "init" >
        <SELECT sql = "with FillCountByQty(workOrderId,
                                           lineNo,
                                           qtyRequired,
                                           ts) as
                       (
                         select w.workOrderId,
                                l.lineNo,
                                qtyRequired,
                                l.ts
                           from WorkOrders w
                           join WorkOrderLines l
                           join UnitPrice p
                             on l.unit = p.unit
                            and l.unitType = p.unitType
                           where w.workOrderType = 'cluster'
                             and l.status = gWoLinePicked
                             and p.unitPrice > 0
                       ),
                       OperPickedQty(day,
                                     workOrderId,
                                     lineNo,
                                     qtyRequired,
                                     qtyPicked) as
                       (              
                         select date(l.ts) day,
                                l.workOrderId,
                                l.lineNo,
                                l.qtyRequired,
                                sum(o.qtyCompleted) qtyPicked
                           from FillCountByQty l
                           join WorkOrderLineOperations o
                             on l.workOrderId = o.workOrderId
                            and l.lineNo = o.lineNo
                           group by day,
                                    l.workOrderId,
                                    l.lineNo,
                                    l.qtyRequired
                       )
                       select Day,
                              sum(qtyRequired) QtyRequired,
                              sum(qtyPicked) QtyPicked,
                              cast((100.00 * qtyPicked)/qtyRequired as decimal(6,2)) FillRate
                       from OperPickedQty 
                       where day &gt;= today() - 30        
                       group by Day 
                       order by Day desc" />
                       
        <TABLECOLUMNS>
          <TABLECOLUMN name = "QtyRequired"  
                       align = "right" />
          <TABLECOLUMN name = "QtyPicked"  
                       align = "right" />
          <TABLECOLUMN name = "QtyRequired"  
                       align = "right" />
          <TABLECOLUMN name = "FillRate"  
                       align = "right" />
        </TABLECOLUMNS>          

      </TABLE>
    </FLEXTABLECOMPONENT>

    <FLEXTABLECOMPONENT name = "fillRateShortInv" 
                        init = "init" 
                        records = "1000"
                        greenbar = "true"
                        refresh = "true" >

      <TRIGGER name = "init" />
      <DBCONNECT type = "global" />

      <TABLE key = "init" >
        <SELECT sql = "with FillCountByQty(workOrderId,
                                            lineNo,
                                            unit,
                                            unitType,
                                            qtyRequired,
                                            ts) as
                        (
                          select w.workOrderId,
                                l.lineNo,
                                unit,
                                unitType,
                                qtyRequired,
                                l.ts
                           from WorkOrders w
                           join WorkOrderLines l
                           where w.workOrderType = 'cluster'
                             and l.status = gWoLinePicked
                            and date(l.ts) = today()
                      ),
                      OperPickedQty(day,
                                    workOrderId,
                                    lineNo,
                                    unit,
                                    unitType,
                                     qtyRequired,
                                     qtyPicked) as
                       (              
                         select date(l.ts) day,
                                l.workOrderId,
                                l.lineNo,
                                l.unit,
                                l.unitType,
                                l.qtyRequired,
                                sum(o.qtyCompleted) qtyPicked
                           from FillCountByQty l
                           join WorkOrderLineOperations o
                             on l.workOrderId = o.workOrderId
                            and l.lineNo = o.lineNo
                           join UnitPrice p
                             on l.unit = p.unit
                            and l.unitType = p.unitType
                           where p.unitPrice > 0
                           group by day,
                                    l.workOrderId,
                                    l.lineNo,
                                    l.unit,
                                    l.unitType,             
                                    l.qtyRequired
                           having qtyPicked &lt; l.qtyRequired       
                        )
                        select Day,
                               Unit,
                               UnitType,
                               sum(qtyRequired) QtyRequired,
                               sum(qtyPicked) QtyPicked,
                               InventoryGetGetTotalQty(unit, unitType) InvQty,
                               if(AcceptableStorageUnitExists(null, null, Unit) = 1) then
                                 'PTL' 
                               else 
                                 'OPEX' 
                               endif Area
                          from OperPickedQty 
                          group by Day,
                                   Unit,
                                   UnitType
                          having QtyRequired != QtyPicked 
                             and qtyPicked &lt;= InvQty 
                          order by QtyRequired desc"/>
      <TABLECOLUMNS>
        <TABLECOLUMN name = "QtyRequired"  
                     align = "right" />
        <TABLECOLUMN name = "QtyPicked"  
                     align = "right" />
        <TABLECOLUMN name = "InvQty"  
                     align = "right" />
      </TABLECOLUMNS>        

      </TABLE>
    </FLEXTABLECOMPONENT>
  </SPLITPANE>
</FLEXSCREEN>
