<?xml version="1.0"?>
<!--
   - Filename:     orderStatus.xml
   - Description:
   -
   - (c) COPYRIGHT QC Software, LLC 2018 All Rights Reserved
   - No part of this copyrighted work may be reproduced, modified, or
   - distributed in any form or by any means without the prior written
   - permission of QC Software, LLC.
   -
   - $Id: orderStatus.xml 10242 2018-06-06 19:46:47Z wlw $
   - Notes:
  -->
<FLEXSCREEN title           = "Order Status"
            height          = "550"
            width           = "1100"
            frametype       = "internal"
            globalThreading = "true"
            updateSecurity  = "orderStatus.edit"
            insertSecurity  = "orderStatus.insert"
            deleteSecurity  = "orderStatus.delete">

  <DBCONNECT type         = "predefined"
             connectionId = "default"
             setglobal    = "true"/>

  <ADD_DICTIONARIES>
    <DICTIONARY namespace = "DbShippingDictionary"
                class = "Library.Language.Dictionaries.DbShippingDictionary" />
  </ADD_DICTIONARIES>

  <GLOBAL_DEFINITIONS>
    <VECTORMAP name    = "orderStatusMap"
               loadSql = "SELECT idx, returnCodeMsg
                            FROM MnemonicCodesView
                           WHERE mnemonicType = 'ORDER_STATUSES'
                           ORDER BY idx" />

    <VECTORMAP name    = "manifestedContainerStatusMap"
               loadSql = "SELECT idx, returnCodeMsg
                            FROM MnemonicCodesView
                           WHERE mnemonicType = 'MANIFESTED_CONTAINER_STATUSES'
                           ORDER BY idx" />

    <VECTORMAP name    = "manifestedItemStatusMap"
               loadSql = "SELECT idx, returnCodeMsg
                            FROM MnemonicCodesView
                           WHERE mnemonicType = 'MANIFESTED_ITEM_STATUSES'
                           ORDER BY idx" />

    <VECTORMAP name    = "muStatusMap"
               loadSql = "SELECT idx, returnCodeMsg
                            FROM MnemonicCodesView
                           WHERE mnemonicType = 'MOVEABLE_UNIT_STATUSES'
                           ORDER BY idx" />

    <VECTOR    name    = "muStatuses"
               loadSql = "SELECT returnCodeMsg
                            FROM MnemonicCodesView
                           WHERE mnemonicType = 'MOVEABLE_UNIT_STATUSES'
                           ORDER BY idx" />

    <VECTORMAP name    = "muFlagMap"
               loadSql = "SELECT returnCodeMsg, idx
                            FROM MnemonicCodesView
                           WHERE mnemonicType = 'MOVEABLE_UNIT_FLAGS'
                           ORDER BY idx" />

    <VECTOR    name    = "muItemStatuses"
               loadSql = "SELECT returnCodeMsg
                            FROM MnemonicCodesView
                           WHERE mnemonicType = 'MOVEABLE_UNIT_ITEM_STATUSES'
                           ORDER BY idx" />
                           
    <VECTORMAP name    = "muItemFlagMap"
               loadSql = "SELECT returnCodeMsg, idx
                            FROM MnemonicCodesView
                           WHERE mnemonicType = 'MOVEABLE_UNIT_ITEM_FLAGS'
                           ORDER BY idx" />

    <VECTORMAP name    = "muItemStatusMap"
               loadSql = "SELECT idx, returnCodeMsg
                            FROM MnemonicCodesView
                           WHERE mnemonicType = 'MOVEABLE_UNIT_ITEM_STATUSES'
                           ORDER BY idx" />

    <VECTORMAP name    = "woStatusMap"
               loadSql = "SELECT idx, returnCodeMsg
                            FROM MnemonicCodesView
                           WHERE mnemonicType = 'WORK_ORDER_STATUSES'
                           ORDER BY idx" />

    <VECTOR name    = "woStatuses"
            loadSql = "SELECT returnCodeMsg
                         FROM MnemonicCodesView
                        WHERE mnemonicType = 'WORK_ORDER_STATUSES'
                        ORDER BY idx" />

    <VECTORMAP name    = "woLineStatusMap"
               loadSql = "SELECT idx, returnCodeMsg
                            FROM MnemonicCodesView
                           WHERE mnemonicType = 'WORK_ORDER_LINE_STATUSES'
                           ORDER BY idx" />

    <VECTOR    name    = "woLineStatuses"
               loadSql = "SELECT returnCodeMsg
                            FROM MnemonicCodesView
                           WHERE mnemonicType = 'WORK_ORDER_LINE_STATUSES'
                           ORDER BY idx" />

    <VECTORMAP name    = "woLineFlagMap"
               loadSql = "SELECT returnCodeMsg, idx
                            FROM MnemonicCodesView
                           WHERE mnemonicType = 'WORK_ORDER_LINE_FLAGS'
                           ORDER BY idx" />

    <VECTORMAP name    = "woStatusMapByName"
               loadSql = "SELECT returnCodeMsg, idx
                            FROM MnemonicCodesView
                           WHERE mnemonicType = 'WORK_ORDER_STATUSES'
                           ORDER BY idx"/>
  </GLOBAL_DEFINITIONS>

  <BORDER_COMPONENT orientation = "south" >
    <ACTIVITY_PANEL labelColor = "red" messageColor = "blue" >
      <SOURCE sourceName = "OrderList" />
      <SOURCE sourceName = "StatusTable" />
    </ACTIVITY_PANEL>
  </BORDER_COMPONENT>

  <SPLITPANE  divider = "110" orientation = "vertical" >
    <FLEXSQLMODIFIERCOMPONENT name              = "OrderFilter"
                              appendAsAnd       = "false"
                              makeAbsolute      = "true"
                              autoResize        = "false"
                              autoExecute       = "true"
                              labelsOnTop       = "false"
                              maxFilterRows     = "3"
                              editorWidth       = "150"
                              showCheckBoxes    = "false"
                              filterBorderText  = "Filter Criteria"
                              filterBorderColor = "blue"
                              okButtonText      = "Execute"
                              passiveMode       = "true"
                              orientation       = "horizontal"
                              roundedCorners    = "true" >

      <DBCONNECT type = "global"/>

      <FILTER_OPTION label      = "WorkOrderId"
                     altValue   = "workOrder"
                     editorType = "text"
                     autoQuote  = "true" />

      <FILTER_OPTION label      = "WaveNo"
                     altValue   = "waveNo"
                     editorType = "text"
                     autoQuote  = "true" />

      <FILTER_OPTION label      = "WaveName"
                     altValue   = "waveName"
                     editorType = "text"
                     autoQuote  = "true" />

      <FILTER_OPTION label      = "Unit"
                     altValue   = "unit"
                     editorType = "text"
                     autoQuote  = "true" />
                     
      <FILTER_OPTION label      = "UnitType"
                     altValue   = "unitType"
                     editorType = "text"
                     autoQuote  = "true" />
                     
      <FILTER_OPTION label = "Status"
                     altValue = "status"
                     editorType = "combo"
                     autoQuote = "true" >
        <COMBO_OPTIONS ifdef = "woStatusMapByName" loadEmptyItem = "true"/>
      </FILTER_OPTION>

      <FILTER_OPTION label      = "MoveableUnitId"
                     altValue   = "mu"
                     editorType = "text"
                     autoQuote  = "true" />
    </FLEXSQLMODIFIERCOMPONENT>

    <SPLITPANE divider = "150" orientation = "horizontal" >
      <FLEXLISTCOMPONENT name           = "OrderList"
                         greenbar       = "true"
                         autoSelect     = "true"
                         records        = "25">

        <DBCONNECT type = "global" />
        <TRIGGER name = "OrderFilter" />

        <LIST key = "OrderFilter:execute"
              title = "Orders"
              icon = "workorder.gif"
              color = "sienna">
        
          <SELECT sql = "CALL OrderStatusScreen(//waveNo,
                                                //waveName,
                                                //workOrder,
                                                null,
                                                //status,
                                                //mu,
                                                null,
                                                //unit,
                                                //unitType,
                                                null,
                                                'WorkOrderId')"/>
        </LIST>
      </FLEXLISTCOMPONENT>

      <!--
        - Work Order
        -->
      <TABPANE tabplacement = "top">
        <!--
          - ORDERS TAB
          -->
        <TAB title = "Orders" >
          <!--
            - Every flex component has a name which is needed for referencing
            - and attaching listeners.
            -->

          <FLEXTABLECOMPONENT name     = "OrderTable"
                              refreshOnUpdate = "true"
                              greenbar = "true"
                              log      = "true">
            <DBCONNECT type = "global" />
            <TRIGGER name = "OrderList" />

            <TABLE key = "OrderList" >
              <SELECT sql = "select distinct w.workOrderId WorkOrderId,
                                    w.waveNo WaveNo,
                                    w.WorkOrderType,
                                    FlagDisplayer('WORK_ORDER_FLAGS', w.flags) Flags,
                                    w.Status,
                                    w.ReceivedTs,
                                    w.CompleteTs,
                                    w.Ts
                               from WorkOrders w
                              where w.workOrderId = //OrderList"/>

              <UPDATE sql = "update WorkOrders
                                set status = //Status
                              where workOrderId = //WorkOrderId"/>

              <ALTVALUES>
                <FIELD name = "Status" ifdef = "woStatusMap" />
              </ALTVALUES>

              <TABLECOLUMNS>                                     
                <TABLECOLUMN name = "WaveNo"  
                             align = "right"                          
                             preferredWidth = "60"/>
                             
                <TABLECOLUMN name = "Flags"  
                             align = "right"                          
                             preferredWidth = "60"/>                            
              </TABLECOLUMNS>                                     
                                       
              <EDITOR restoreHide = "true" 
                      title = "Order"
                      saveText = "Save" 
                      cancelText = "Cancel">
                <FIELD name = "WorkOrderId">
                  <TEXTFIELD/>
                </FIELD>
                <FIELD name = "Status" 
                       required = "true">
                  <COMBO loadEmptyItem = "true" 
                         ifdef = "woStatuses"/>
                </FIELD>
              </EDITOR>
            </TABLE>
          </FLEXTABLECOMPONENT>
        </TAB>

        <!--
          - WORK ORDER LINES tab
          -->
        <TAB  title = "Lines">
          <SPLITPANE divider = "200" orientation = "vertical" >
            <FLEXTABLECOMPONENT name     = "LinesTableUpper"
                                refreshOnUpdate = "true"
                                greenbar = "true"
                                log      = "true">
              <DBCONNECT type = "global" />
              <TRIGGER name = "OrderList" />

              <TABLE key = "OrderList" >
                <SELECT sql = "CALL OrderStatusScreenLines(//OrderList,
                                                           //mu,
                                                           null,
                                                           'l.WorkOrderId, l.LineNo')"/>

                <UPDATE sql = "UPDATE WorkOrderLines
                                  SET unit = //Unit,
                                      qtyRequired = //QtyRequired,
                                      status = //Status,
                                      flags = //FlagBits
                                WHERE workOrderId = //WorkOrderId
                                  AND lineNo = //LineNo " />

                <TABLECOLUMNS>
                <TABLECOLUMN name = "LineNo"  
                             align = "right"                          
                             preferredWidth = "60"/>
                             
                <TABLECOLUMN name = "QtyRequired"  
                             align = "right"                          
                             preferredWidth = "60"/>
                             
                <TABLECOLUMN name = "Flags"  
                             align = "right"                          
                             preferredWidth = "60"/>     
                             
                  <TABLECOLUMN name  = "WorkOrderId" 
                               preferredWidth = "100"/>
                  <TABLECOLUMN name  = "SourceLocationId" 
                               hide = "true"/>
                  <TABLECOLUMN name  = "DestinationLocationId" 
                               hide = "true"/>
                  <TABLECOLUMN name  = "FlagBits" 
                               hide = "true"/>
                </TABLECOLUMNS>

                <ALTVALUES>
                  <FIELD name = "Status" ifdef = "woLineStatusMap"/>
                </ALTVALUES>

                <EDITOR restoreHide = "true" 
                        title = "Line"
                        saveText = "Save" 
                        cancelText = "Cancel">
                  <FIELD name = "LineNo">
                    <NUMERICFIELD/>
                  </FIELD>
                  <FIELD name = "Status" 
                         required = "true">
                    <COMBO loadEmptyItem = "true" 
                           ifdef = "woLineStatuses"/>
                  </FIELD>
                  <FIELD name = "Unit" 
                         required = "true">
                    <TEXTFIELD cutpaste = "true"/>
                  </FIELD>
                  <FIELD name = "QtyRequired" 
                         required = "true">
                    <NUMERICFIELD/>
                  </FIELD>
                  <FIELD name = "FlagBits" 
                         required = "true">
                    <POPUPBITVALUEEDITOR maxRows = "5">
                      <BIT_VALUES ifdef = "woLineFlagMap"/>
                    </POPUPBITVALUEEDITOR>
                  </FIELD>
                </EDITOR>
              </TABLE>
            </FLEXTABLECOMPONENT>

            <!--
              - Lower Panel
              -->
            <FLEXTABLECOMPONENT name     = "LinesTableLower"
                                refreshOnUpdate = "true"
                                greenbar = "true"
                                log      = "true">
              <DBCONNECT type = "global" />
              <TRIGGER name = "LinesTableUpper" />
              <TABLE key = "LinesTableUpper:OrderList"
                     title = "Operations">

                <SELECT sql = "select o.Idx,
                                      o.Qty,
                                      o.QtyCompleted,
                                      o.LocationId,
                                      lcd.CheckDigits,
                                      o.RouteId,
                                      o.ZoneId,
                                      o.MoveableUnitId,
                                      o.AltMoveableUnitId,
                                      o.OperatorId,
                                      o.Status,
                                      FlagDisplayer('WORK_ORDER_LINE_FLAGS', o.Flags) Flags,
                                      o.Flags FlagBits,
                                      o.CompleteTs,
                                      o.Ts
                                 from WorkOrderLineOperations o
                                 left outer join locationCheckDigits lcd
                                   on lcd.locationId = o.locationId
                                 left outer join checkDigitGroup cdg
                                   on cdg.groupId = lcd.groupId
                                  and cdg.active = 'Y'
                                where o.workOrderId = //OrderList
                                  and o.lineNo = //LineNo
                                order by o.Idx"/>

                <UPDATE sql = "call UpdateWorkOrderLineOperationEx(/*OrderList,
                                                                   /*LineNo, 
                                                                   /*Idx, 
                                                                   /*Qty, 
                                                                   //QtyCompleted, 
                                                                   /*LocationId, 
                                                                   /*RouteId, 
                                                                   /*ZoneId, 
                                                                   /*MoveableUnitId, 
                                                                   '$QC_USER', 
                                                                   //Status,
                                                                   //FlagBits)"/>

                <DELETE sql = "delete from workOrderLineOperations
                                where workOrderId = //OrderList
                                  and lineNo = //LineNo
                                  and idx = //Idx" />

                <TABLECOLUMNS>
                  <TABLECOLUMN name = "Idx"  
                               align = "right"                          
                               preferredWidth = "60"/>
                             
                  <TABLECOLUMN name = "Qty"  
                               align = "right"                          
                               preferredWidth = "60"/>
                             
                  <TABLECOLUMN name = "QtyCompleted"  
                               align = "right"                          
                               preferredWidth = "60"/>
                             
                  <TABLECOLUMN name  = "FlagBits" 
                               hide = "true"/>
                </TABLECOLUMNS>

                <ALTVALUES>
                  <FIELD name = "Status" 
                         ifdef = "woLineStatusMap" />
                </ALTVALUES>

                <EDITOR restoreHide = "true" 
                        title = "Operation"
                        saveText = "Save" 
                        cancelText = "Cancel">
                  <FIELD name = "Idx">
                    <NUMERICFIELD/>
                  </FIELD>

                  <FIELD name = "Status" 
                         required = "true">
                    <COMBO loadEmptyItem = "true" 
                           ifdef = "woLineStatuses"/>
                  </FIELD>

                  <FIELD name = "QtyCompleted" 
                         required = "false">
                    <NUMERICFIELD/>
                  </FIELD>

                  <FIELD name = "FlagBits">
                    <POPUPBITVALUEEDITOR maxRows = "5">
                      <BIT_VALUES ifdef = "woLineFlagMap"/>
                    </POPUPBITVALUEEDITOR>
                  </FIELD>
                </EDITOR>
              </TABLE>
            </FLEXTABLECOMPONENT>
          </SPLITPANE>
        </TAB>

        <!--
          - Moveable Unit tab
          -->
        <TAB title = "MoveableUnit" >
          <SPLITPANE divider = "150" orientation = "vertical" >
            <FLEXTABLECOMPONENT name     = "MoveableUnitTable"
                                refreshOnUpdate = "true"
                                greenbar = "true"
                                log      = "true">
              <DBCONNECT type = "global" />
              <TRIGGER name = "OrderList" />

              <TABLE key = "OrderList" 
                     title = "MoveableUnitStatus">

                <SELECT sql = "select distinct mu.MoveableUnitId,
                                      mu.LocationId,
                                      mu.ZoneId,
                                      mu.StorageUnitType,
                                      mu.Status,
                                      FlagDisplayer('MOVEABLE_UNIT_FLAGS', mu.Flags) Flags,
                                      mu.Flags FlagBits,
                                      mu.StartTs,
                                      mu.CompleteTs,
                                      mu.Ts
                                 from MoveableUnits mu
                                 join workOrderLineOperations o
                                   on o.moveableUnitId = mu.moveableUnitId
                                where o.workOrderId = //OrderList
                                order by mu.moveableUnitId" />

                <UPDATE sql = "UPDATE moveableUnits
                                  SET locationId = //LocationId,
                                      zoneId = //ZoneId,
                                      status = //Status,
                                      flags = //FlagBits
                                WHERE moveableUnitId = //MoveableUnitId" />

                <TABLECOLUMNS>
                  <TABLECOLUMN name  = "FlagBits" hide = "true"/>
                </TABLECOLUMNS>

                <ALTVALUES>
                  <FIELD name = "Status" ifdef = "muStatusMap" />
                </ALTVALUES>

                <EDITOR restoreHide = "true" 
                        title = "MoveableUnit"
                        saveText = "Save" 
                        cancelText = "Cancel">
                  <FIELD name = "MoveableUnitId">
                    <TEXTFIELD/>
                  </FIELD>
                  <FIELD name = "LocationId">
                    <TEXTFIELD/>
                  </FIELD>
                  <FIELD name = "ZoneId">
                    <TEXTFIELD/>
                  </FIELD>
                  <FIELD name = "Status" 
                         required = "true">
                    <COMBO loadEmptyItem = "true" 
                           ifdef = "muStatuses"/>
                  </FIELD>
                  <FIELD name = "FlagBits">
                    <POPUPBITVALUEEDITOR maxRows = "5">
                      <BIT_VALUES ifdef = "muFlagMap"/>
                    </POPUPBITVALUEEDITOR>
                  </FIELD>
                </EDITOR>
              </TABLE>
            </FLEXTABLECOMPONENT>

            <!--
              - Lower Panel
              -->
            <FLEXTABLECOMPONENT name     = "MoveableUnitItemTable"
                                refreshOnUpdate = "true"
                                greenbar = "true"
                                log      = "true">
              <DBCONNECT type = "global" />
              <TRIGGER name = "MoveableUnitTable" />

              <TABLE key = "MoveableUnitTable:OrderList" 
                     title = "MoveableUnitItems">
                <SELECT sql = "select mui.Idx,
                                      mui.workOrderLineNo LineNo,
                                      mui.Unit,
                                      mui.Qty,
                                      mui.Status,
                                      FlagDisplayer('MOVEABLE_UNIT_ITEM_FLAGS',
                                                    flags) Flags,
                                      mui.Flags FlagBits,
                                      dateformat(mui.Ts, gDateTimeFormat) Ts
                                 from moveableUnitItems mui
                                where mui.moveableUnitId = //MoveableUnitId
                                order by mui.unit" />

                <UPDATE sql = "UPDATE moveableUnitItems
                                  SET qty = //Qty,
                                      status = //Status,
                                      flags = //FlagBits
                                WHERE moveableUnitId = //MoveableUnitId
                                  AND idx = //Idx" />

                <DELETE sql = "delete from MoveableUnitItems
                                where moveableUnitId = //MoveableUnitId
                                  and idx = //Idx" />

                <ALTVALUES>
                  <FIELD name = "Status" ifdef = "muItemStatusMap" />
                </ALTVALUES>

                <TABLECOLUMNS>
                  <TABLECOLUMN name = "LineNo"  
                               align = "right"                          
                               preferredWidth = "60"/>
                               
                  <TABLECOLUMN name = "Idx"  
                               align = "right"                          
                               preferredWidth = "60"/>
                               
                  <TABLECOLUMN name = "Qty"  
                               align = "right"                          
                               preferredWidth = "60"/>
                               
                  <TABLECOLUMN name  = "FlagBits" 
                               hide = "true"/>
                </TABLECOLUMNS>

                <EDITOR restoreHide = "true" 
                        title = "MoveableUnitItem"
                        saveText = "Save" 
                        cancelText = "Cancel">
                  <FIELD name = "Idx">
                    <NUMERICFIELD/>
                  </FIELD>
                  <FIELD name = "Qty" 
                         required = "true">
                    <NUMERICFIELD/>
                  </FIELD>
                  <FIELD name = "Status" 
                         required = "true">
                    <COMBO loadEmptyItem = "true" 
                           ifdef = "muItemStatuses"/>
                  </FIELD>
                  <FIELD name = "FlagBits">
                    <POPUPBITVALUEEDITOR maxRows = "5">
                      <BIT_VALUES ifdef = "muItemFlagMap"/>
                    </POPUPBITVALUEEDITOR>
                  </FIELD>
                </EDITOR>
              </TABLE>
            </FLEXTABLECOMPONENT>
          </SPLITPANE>
        </TAB>
        
        <!--
          Manifest Tab
        -->
        <Include includeFlag = "0x0010"
                 filename = "$SCREEN_CONFIG_DIR/MenuOperations/orderStatusManifestTab.xml"/>
       
        <!--
          - Routes tab
          -->
        <TAB title = "Routes" >
          <FLEXTABLECOMPONENT name     = "RoutesTable"
                              greenbar = "true"
                              log      = "true">
            <DBCONNECT type = "global" />
            <TRIGGER name = "OrderList" />

            <TABLE key = "OrderList" 
                   title = "Routes">

              <SELECT sql = "select distinct r.ContainerId MoveableUnitId,
                                    rd.Description,
                                    r.Status
                               from ContainerRoutes r
                               join RouteDescriptions rd
                                 on r.routeId = rd.routeId
                               join WorkOrderLineOperations o
                                 on o.moveableUnitId = r.containerId
                              where o.workOrderId = //OrderList
                              order by r.containerId, rd.description" />
  
              <ALTVALUES>
                <FIELD name = "Status" ifdef = "orderStatusMap" />
              </ALTVALUES>
            </TABLE>
          </FLEXTABLECOMPONENT>
        </TAB>
      </TABPANE>
    </SPLITPANE>
  </SPLITPANE>
</FLEXSCREEN>
