<?xml version="1.0"?>
<!--
   - Filename:     dbLocksReport.xml
   - Description:
   -
   - (c) COPYRIGHT QC Software, LLC 2017 All Rights Reserved
   - No part of this copyrighted work may be reproduced, modified, or
   - distributed in any form or by any means without the prior written
   - permission of QC Software, LLC.
   -
   - $Id: dbLocksReport.xml 10242 2018-06-06 19:46:47Z wlw $
   - Notes:
  -->
<FLEXSCREEN title = "Database Lock Report" height = "600" width = "1000"
            frametype = "internal"
            report = "true">

  <!-- a dbConnect here is a universal connect object  -->
  <DBCONNECT type = "predefined" 
             connectionId = "default" 
             setglobal = "true"/>

  <GLOBAL_DEFINITIONS>
    <VECTOR name = "operators1"> 
       <ITEM value = " =" />
       <ITEM value = "like" />
    </VECTOR>

    <VECTOR name = "operators2"> 
       <ITEM value = " =" />
       <ITEM value = "&lt;" />
       <ITEM value = "&lt;=" />
       <ITEM value = "&lt;&gt;" />
       <ITEM value = "&gt;" />
       <ITEM value = "&gt;=" />
    </VECTOR>
    
    <VECTOR name = "operatorIn"> 
       <ITEM value = "in" />
       <ITEM value = "out" />
    </VECTOR>
  </GLOBAL_DEFINITIONS>

  <REPORTS>
    <DBCONNECT type = "global" />
    <REPORT name = "Database Locks" orientation = "landscape" >
      <REPORTTITLE title = "Database Locks" />
      <SELECT sql = "call TableLocksPrintReport()"/>
    </REPORT>
  </REPORTS>

  <TABPANE>
    <TAB title = "Database Locks">
      <SPLITPANE  divider = "70" orientation = "vertical">
        <FLEXSQLMODIFIERCOMPONENT  name = "ConnectedUsers"
                                   orientation = "horizontal"
                                   appendAsAnd = "false"
                                   makeAbsolute = "false"
                                   autoResize = "false"
                                   autoExecute = "true"
                                   maxFilterRows = "1"
                                   editorWidth = "120"
                                   showCheckBoxes = "false"
                                   filterBorderText = "Filter Criteria"
                                   filterBorderColor = "blue"
                                   okButtonText = "Refresh"
                                   passiveMode = "false">

        <FILTER_OPTION label = "UserId" 
                       altValue = "userId" 
                       editorType = "text" 
                       autoQuote = "true" />

        </FLEXSQLMODIFIERCOMPONENT>
          <FLEXTABLECOMPONENT name = "dbLocksMonthTable" 
                              init = "init" 
                              refresh = "true" 
                              greenbar = "true"
                              ignoreEventConcatenation = "true">

            <DBCONNECT type = "global" />
            <TRIGGER name = "ConnectedUsers" />
 
            <TABLE key = "ConnectedUsers:execute" >
              <SELECT sql = "call TableLocksCheckForLock(//UserId)" />

              <TABLECOLUMNS>
              </TABLECOLUMNS>

            </TABLE>
          </FLEXTABLECOMPONENT>
       </SPLITPANE>
    </TAB>

    <TAB title = "Database Conections">
      <SPLITPANE  divider = "250" 
                  orientation = "vertical">
        <FLEXTABLECOMPONENT name = "dbConnectsTable" 
                            init = "init" 
                            refresh = "true" 
                            greenbar = "true">

          <DBCONNECT type = "global" />
          <TRIGGER name = "dbConnectsTrig" />

          <TABLE key = "init" >
            <SELECT sql = "select UserId UserId, 
                                  count(UserId) ConnectionCt,
                                  list(number order by number) ConnectionNos
                             from  sa_conn_info(null)
                            group by UserId
                            order by ConnectionCt desc" />

            <TABLECOLUMNS>
            </TABLECOLUMNS>
          </TABLE>
        </FLEXTABLECOMPONENT>

        <FLEXTABLECOMPONENT name = "dbConnectTableLower" 
                            refresh = "true" 
                            greenbar = "true">

          <DBCONNECT type = "global" />

          <TRIGGER name = "dbConnectsTable" />
          <TABLE key = "dbConnectsTable:init" >
            <SELECT sql = "select number ConnectionNo,  
                                  UserId,
                                  Name,
                                  LastReqTime,  
                                  ClientPort,
                                  ReqType,
                                  BlockedOn,
                                  LockTable
                             from sa_conn_info(null)
                            where userId = //UserId  
                            order by number" />

            <TABLECOLUMNS>
            </TABLECOLUMNS>
          </TABLE>
        </FLEXTABLECOMPONENT>
       </SPLITPANE>
    </TAB>
  </TABPANE>
</FLEXSCREEN>
